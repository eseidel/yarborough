#!/usr/bin/env bash
# Watch CI and iteratively fix issues until all checks pass

set -e

PR_NUMBER=${1:-}

if [ -z "$PR_NUMBER" ]; then
  echo "Usage: .agent/workflows/watch-and-fix-ci <pr-number>"
  exit 1
fi

echo "Watching CI for PR #$PR_NUMBER and fixing issues..."
echo ""

while true; do
  echo "Checking CI status..."
  CI_STATUS=$(gh pr checks $PR_NUMBER 2>&1 || true)

  # Check if all passed
  if echo "$CI_STATUS" | grep -q "^TypeScript.*pass" && echo "$CI_STATUS" | grep -q "^Rust.*pass"; then
    echo "✅ All CI checks passed!"
    echo "$CI_STATUS"
    break
  fi

  # Show current status
  echo "$CI_STATUS" | grep -E "^(TypeScript|Rust)"
  echo ""

  # Check for common failures and suggest fixes
  if echo "$CI_STATUS" | grep -q "fail"; then
    echo "CI failed. Running local checks to identify issues..."
    echo ""

    # Try running lints locally
    if ! .agent/workflows/check-lints 2>&1; then
      echo ""
      echo "Lint issues found. Auto-fixing..."
      .agent/workflows/fix-lints

      echo "Committing fixes..."
      git add -A
      git commit -m "chore: Fix linting issues" || true
      git push

      echo "Waiting for new CI run..."
      sleep 30
      continue
    fi

    # Try running tests locally
    if ! .agent/workflows/run-tests 2>&1; then
      echo ""
      echo "❌ Tests failing locally. Please fix manually."
      exit 1
    fi

    echo "Local checks pass but CI fails. Check CI logs:"
    gh pr checks $PR_NUMBER | grep fail
    break
  fi

  echo "Waiting for CI to complete..."
  sleep 15
done
